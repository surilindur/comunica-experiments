services:
  solidserver:
    build:
      context: ./solidserver
      network: host
    container_name: solidserver
    environment:
      CSS_BASE_URL: http://localhost:3000
      CSS_CONFIG: /tmp/config.json
      CSS_LOGGING_LEVEL: info
      CSS_PORT: 3000
      CSS_ROOT_FILE_PATH: /var/cssdata
    healthcheck:
      test: curl -I http://localhost:3000/pods/
      interval: 10s
      timeout: 1s
      retries: 3
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./solidserver/config.json:/tmp/config.json:ro
      - ../generated/out-fragments/http/localhost_3000:/var/cssdata:ro
  comunica:
    build:
      context: ./comunica
      network: host
    command: --freshWorker --idp void --context /tmp/context.json --port 4000 --timeout 120
    container_name: comunica
    depends_on:
      solidserver:
        condition: service_healthy
    environment:
      COMUNICA_CONFIG: /tmp/config.json
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./comunica/context.json:/tmp/context.json:ro
      - ./comunica/config-${COMUNICA_CONFIG}.json:/tmp/config.json:ro
